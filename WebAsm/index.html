<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>C WASM Example</title>
  </head>
  <body>
    <h1>WebAssembly from C</h1>
    <button id="add-btn">Add 3 + 4</button>
    <button id="mult-btn">Multiply 3 * 4</button>
    <button id="fib-btn">Generate fibonacci numbers</button>
    <input id="fib-cnt" type="number" placeholder="# of fib nums to generate" />
    <p id="output"></p>

    <script src="main.js"></script>
    <script>
      Module.onRuntimeInitialized = () => {
        const add = Module.cwrap("add", "number", ["number", "number"]);
        const mult = Module.cwrap("mult", "number", ["number", "number"]);
        const fib = Module.cwrap("fib", "number", ["number"]);

        document.getElementById("add-btn").onclick = () => {
          const result = add(3, 4);
          document.getElementById("output").textContent = "Result: " + result;
        };

        document.getElementById("mult-btn").onclick = () => {
          const result = mult(3, 4);
          document.getElementById("output").textContent = "Result: " + result;
        };

        document.getElementById("fib-btn").onclick = () => {
          const fibCount = document.getElementById("fib-cnt").value;
          const result = verifyFibNum(fibCount);
          if (result === 0) {
            const ptr = fib(fibCount); // pointer to array in WASM memory

            const result = [];
            for (let i = 0; i < fibCount; i++) {
              result.push(Module.HEAP32[(ptr >> 2) + i]); // Read each 32-bit int
            }

            document.getElementById("output").textContent =
              "Fibonacci: " + result.join(", ");
          } else {
            if (result === 1)
              document.getElementById("output").textContent =
                "Please specify a whole #";
            else if (result === 2)
              document.getElementById("output").textContent =
                "Please specify a number <= 46";
            else if (result === 3)
              document.getElementById("output").textContent = 
                "Please specify a number > 0";
            else 
              document.getElementById("output").textContent = "Unknown error";
          }
        };

        // functions
        function verifyFibNum(num) {
          if (num % 1 != 0) return 1;
          else if (num > 46) return 2;
          else if (num <= 0) return 3;
          else return 0;
        }
      };
    </script>
  </body>
</html>
